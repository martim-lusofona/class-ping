{% extends "class_attendance/layout.html" %} {% block content %}

<div class="container">
  <div class="d-flex justify-content-between mt-3">
    <h1 class="text-center">{{ course.label }} {{school_class.start_time}} -
      {{school_class.end_time}} - Students</h1>
    
  </div>

  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{% url 'class_attendance:universities' %}"
          >{{ university.label }}</a
        >
      </li>
      <li class="breadcrumb-item">
        <a href="{% url 'class_attendance:courses' university.id %}">Courses</a>
      </li>
      <li class="breadcrumb-item">
        <a href="{% url 'class_attendance:school-classes' course.id %}"
          >{{ course.label }}</a
        >
      </li>
      <li class="breadcrumb-item">
        <a
          href="{% url 'class_attendance:sessions' course.id school_class.id %}"
          >Sessions</a
        >
      </li>
      <li class="breadcrumb-item active" aria-current="page">Students</li>
    </ol>
  </nav>

  <div class="toast-container position-fixed top-0 end-0 p-3"></div>

  <table class="table mt-3 table-striped table-hover">
    
    <thead>
      <tr>
        <th scope="col" class="text-start" style="width: 20%;">Name</th>
        <th scope="col" class="text-center" style="width: 30%;">Student Number</th>
        <th scope="col" class="text-end" style="width: 30%;">Actions</th>        
      </tr>
    </thead>
    <tbody>
      {% for student in students %}
      <tr class="table-row">
        <td class="text-start">  
            {{ student.first_name }} {{ student.last_name }}
        </td>
        <td class="text-center">{{ student.number }}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary me-2 edit-name-btn" data-student-id="{{ student.number }}" data-student-name="{{ student.first_name }} {{ student.last_name }}">
            Edit Name
          </button>
          <button class="btn btn-sm btn-outline-danger remove-student-btn" data-student-id="{{ student.number }}">
            Remove
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if students|length == 0 %}
    <p class="text-center">No students registered for this session.</p>
  {% endif %}
  
</div>

<script>
  const toastContainer = document.querySelector('.toast-container');

  function showToast(message) {
    const toastElement = document.createElement('div');
    toastElement.className = 'toast';
    toastElement.setAttribute('role', 'alert');
    toastElement.setAttribute('aria-live', 'assertive');
    toastElement.setAttribute('aria-atomic', 'true');

    toastElement.innerHTML = `
      <div class="toast-header d-flex justify-content-between">
        <small>just now</small>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">
        ${message}
      </div>
    `;
    toastContainer.appendChild(toastElement);

    const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 5000 });
    toast.show();
  }

  // Edit name functionality
  document.querySelectorAll('.edit-name-btn').forEach(button => {
    button.addEventListener('click', function() {
      const studentId = this.getAttribute('data-student-id');
      const currentName = this.getAttribute('data-student-name');
      
      const newName = prompt("Enter new name for student", currentName);
      if (newName) {
        const nameParts = newName.split(" ");
        const firstName = nameParts[0];
        const lastName = nameParts.slice(1).join(" ");
        
        fetch(`/api/students/${studentId}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ first_name: firstName, last_name: lastName })
        })
          .then(response => response.json())
          .then(data => {
            showToast("Student name updated successfully!");
            // Refresh the page to show updated data
            window.location.reload();
          })
          .catch(error => {
            console.error("Error updating student name:", error);
            showToast("Error updating student name");
          });
      }
    });
  });

  // Remove student functionality
  document.querySelectorAll('.remove-student-btn').forEach(button => {
    button.addEventListener('click', function() {
      const studentId = this.getAttribute('data-student-id');
      
      if (confirm("Are you sure you want to remove this student?")) {
        fetch(`/api/sessions/{{ session.uuid }}/students/${studentId}`, {
          method: "DELETE"
        })
          .then(response => response.json())
          .then(data => {
            showToast("Student removed successfully!");
            // Refresh the page to show updated data
            window.location.reload();
          })
          .catch(error => {
            console.error("Error removing student:", error);
            showToast("Error removing student");
          });
      }
    });
  });
</script>
{% endblock content %}
